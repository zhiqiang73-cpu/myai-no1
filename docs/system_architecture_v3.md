# 币安期货强化学习交易系统 - 完整架构文档

## 一、系统概述

**目标**：通过强化学习自动优化支撑阻力位特征权重，实现高频1分钟波段交易

**核心特性**：
- 多仓位管理（最多3个同方向仓位）
- 渐进式学习（探索期→学习期→稳定期）
- 多周期分析（1m/15m/8h/1w）
- 动态止损止盈
- 完整思维链记录

---

## 二、交易流程

### 2.1 核心循环（每10秒执行一次）

```
1. 获取K线数据（1m/15m/8h/1w）
   ↓
2. 技术分析（RSI/MACD/布林带/EMA）
   ↓
3. 发现支撑阻力位候选
   ↓
4. 计算最佳支撑/阻力位（多周期加权）
   ↓
5. 判断入场信号
   ↓
6. 检查所有仓位平仓条件
   ↓
7. 执行交易（开仓/平仓）
   ↓
8. 记录交易日志
```

---

## 三、支撑阻力位发现与评分

### 3.1 多周期权重配置

| 周期 | 权重 | 触及次数要求 | 容差 | 说明 |
|------|------|------------|------|------|
| 1分钟 | 70% | 5次满分/3次半分 | 0.15% | 主导，捕捉短期波动 |
| 15分钟 | 20% | 3次满分/2次半分 | 0.3% | 辅助确认 |
| 8小时 | 8% | 2次 | 0.5% | 参考大级别 |
| 周线 | 2% | 1次 | 0.8% | 极少参考 |

**权重计算**：
```
多周期确认度 = 1m_score×0.7 + 15m_score×0.2 + 8h_score×0.08 + 1w_score×0.02
```

### 3.2 支撑阻力位特征（6个维度）

| 特征 | 权重 | 说明 |
|------|------|------|
| 成交量密集度 | 20% | 该价位区间的成交量占比 |
| 触及反弹次数 | 20% | 价格触及后反弹的次数 |
| 反弹幅度 | 15% | 反弹的平均幅度 |
| 假突破次数 | 20% | 突破后回落的次数（强支撑） |
| 持续天数 | 10% | 价位有效的持续时间 |
| 多周期确认 | 15% | 多个周期共同确认 |

**最终评分**：
```
价位评分 = Σ(特征值 × 特征权重)
范围：0-100分
```

---

## 四、入场决策系统

### 4.1 渐进式学习阶段

| 阶段 | 交易数 | 入场门槛 | 距离阈值 | 分差要求 | 安全距离 |
|------|--------|---------|---------|---------|---------|
| 探索期 | 0-30笔 | 30分 | 5% | 8分 | 0.3% |
| 学习期 | 30-100笔 | 40分 | 3% | 10分 | 0.5% |
| 稳定期 | 100+笔 | 50分 | 2% | 12分 | 1.0% |

### 4.2 入场评分系统（满分100分）

#### 1. 大趋势确认（25分）
- 周线+8小时综合判断
- BULLISH：+25分（做多）
- BEARISH：+25分（做空）
- NEUTRAL：0分

#### 2. 最佳支撑/阻力位（25分）
- 价格距离支撑位 < 距离阈值 → 做多加分
- 价格距离阻力位 < 距离阈值 → 做空加分
- 加分 = min(25, 价位评分/4)

#### 3. RSI确认（15分）
- RSI < 35：+15分（超卖，做多）
- RSI < 45：+8分（偏低，做多）
- RSI > 65：+15分（超买，做空）
- RSI > 55：+8分（偏高，做空）

#### 4. MACD确认（20分）
- 金叉（零轴下）：+20分（做多）
- 金叉（零轴上）：+12分（做多）
- 死叉（零轴上）：+20分（做空）
- 死叉（零轴下）：+12分（做空）

#### 5. 布林带确认（15分）
- 触及下轨：+15分（做多）
- 下半区：+8分（做多）
- 触及上轨：+15分（做空）
- 上半区：+8分（做空）

#### 6. 成交量确认（5分）
- 放量 > 1.5倍 + 价格上涨：+5分（做多）
- 放量 > 1.5倍 + 价格下跌：+5分（做空）

### 4.3 入场条件

```
做多信号：
  long_score >= min_score 
  AND long_score > short_score + score_diff
  AND 价格距离阻力位 > 安全距离

做空信号：
  short_score >= min_score 
  AND short_score > long_score + score_diff
  AND 价格距离支撑位 > 安全距离
```

---

## 五、仓位管理

### 5.1 多仓位配置

- **最大仓位数**：3个
- **仓位方向**：同方向（不能反向持仓）
- **资金分配**：每个仓位使用 可用资金 / (3 - 当前仓位数)

### 5.2 止损止盈计算

#### 止损设置
```
最大止损百分比：0.5%（约450U）

做多止损：
  1. 如果有支撑位候选：
     止损 = 最高支撑位 - ATR×0.5
  2. 否则：
     止损 = 入场价 - ATR×1.5
  3. 限制：不超过 入场价 × 0.5%

做空止损：
  1. 如果有阻力位候选：
     止损 = 最低阻力位 + ATR×0.5
  2. 否则：
     止损 = 入场价 + ATR×1.5
  3. 限制：不超过 入场价 × 0.5%
```

#### 止盈设置
```
做多止盈：
  1. 如果有阻力位候选：
     止盈 = 最近阻力位
  2. 否则：
     止盈 = 入场价 + (入场价 - 止损) × 风险收益比

做空止盈：
  1. 如果有支撑位候选：
     止盈 = 最近支撑位
  2. 否则：
     止盈 = 入场价 - (止损 - 入场价) × 风险收益比
```

---

## 六、平仓决策系统

### 6.1 平仓检查频率
- **有持仓时**：每10秒检查一次
- **无持仓时**：每60秒检查一次

### 6.2 平仓条件

#### 1. 固定止损/止盈
- 价格 <= 止损 → 全部平仓
- 价格 >= 止盈 → 全部平仓

#### 2. 动态止损（基于支撑阻力）
- 做多：如果价格跌破新的支撑位 → 平仓
- 做空：如果价格涨破新的阻力位 → 平仓

#### 3. 反转信号
- 15分钟MACD反向 + RSI反向 → 平仓
- 布林带穿越中线 + 趋势反转 → 平仓

#### 4. 移动止损
- 做多：价格创新高时，止损向上移动
- 做空：价格创新低时，止损向下移动

---

## 七、思维链记录

### 7.1 思维链结构

```
{
  "trade_id": "唯一交易ID",
  "timestamp": "交易时间",
  
  "perception": {
    "trend_analysis": "大趋势分析",
    "current_price": "当前价格",
    "key_levels": "关键价位",
    "rsi_15m": "RSI值",
    "macd": "MACD值",
    "bb_position": "布林带位置",
    "volume_ratio": "成交量比",
    "confirmations": "确认项列表",
    "total_score": "总评分"
  },
  
  "action": {
    "direction": "LONG/SHORT",
    "reason": "入场原因",
    "entry_price": "入场价",
    "quantity": "数量",
    "stop_loss": "止损价",
    "take_profit": "止盈价",
    "risk_reward": "风险收益比",
    "leverage": "杠杆倍数",
    "confirmations": "确认项"
  },
  
  "reward": {
    "pnl": "盈亏金额",
    "pnl_percent": "盈亏百分比",
    "exit_reason": "平仓原因",
    "level_score_change": "价位评分变化"
  },
  
  "summary": "高度概括的交易描述"
}
```

### 7.2 思维链示例

```
【感知】大趋势BULLISH(8H上涨)，小趋势NEUTRAL，3项确认(得分59.55)
→ 【行动】LONG入场@91350(大趋势看多、最佳支撑90373、MACD金叉)，止损90315/止盈94684
→ 【奖励】持仓中...
```

---

## 八、学习系统

### 8.1 交易记录

每笔交易记录：
- 交易ID、方向、入场价、出场价
- 数量、杠杆、盈亏、盈亏%
- 出场原因、时间戳

### 8.2 特征有效性评估

```
特征有效性 = 该特征出现的盈利交易数 / 该特征出现的总交易数

当交易数 >= 30笔时：
  - 计算每个特征的有效性
  - 识别最有效的特征
  - 记录权重调整建议
```

### 8.3 权重自动优化

```
当交易数 >= 30笔时：
  1. 计算各特征的有效性
  2. 有效性高的特征 → 权重提升
  3. 有效性低的特征 → 权重降低
  4. 保持权重总和 = 100%
```

---

## 九、技术指标计算

### 9.1 RSI（相对强弱指数）
```
RSI = 100 - (100 / (1 + RS))
RS = 平均上升幅度 / 平均下降幅度
周期：14根K线
```

### 9.2 MACD（指数平滑移动平均线）
```
DIF = EMA(12) - EMA(26)
DEA = EMA(DIF, 9)
MACD = 2 × (DIF - DEA)
```

### 9.3 布林带
```
中线 = SMA(20)
上轨 = 中线 + 2 × 标准差
下轨 = 中线 - 2 × 标准差
BB位置 = (价格 - 下轨) / (上轨 - 下轨)  [0-1]
```

### 9.4 ATR（平均真实波幅）
```
TR = max(H-L, |H-C_prev|, |L-C_prev|)
ATR = SMA(TR, 14)
```

---

## 十、系统参数总结

### 10.1 入场参数

| 参数 | 探索期 | 学习期 | 稳定期 |
|------|--------|--------|--------|
| 最小评分 | 30分 | 40分 | 50分 |
| 距离阈值 | 5% | 3% | 2% |
| 分差要求 | 8分 | 10分 | 12分 |
| 安全距离 | 0.3% | 0.5% | 1.0% |

### 10.2 止损止盈参数

| 参数 | 值 |
|------|-----|
| 最大止损% | 0.5% |
| ATR缓冲倍数 | 0.5 |
| 最小风险收益比 | 0.0（禁用） |
| 移动止损 | 启用 |

### 10.3 检查频率

| 场景 | 频率 |
|------|------|
| 有持仓 | 10秒 |
| 无持仓 | 60秒 |

### 10.4 多仓位配置

| 参数 | 值 |
|------|-----|
| 最大仓位数 | 3 |
| 杠杆倍数 | 10x |
| 最大风险% | 2.0% |

---

## 十一、数据流向

```
币安API (K线数据)
    ↓
技术分析器 (计算指标)
    ↓
支撑阻力发现器 (找候选位)
    ↓
最佳价位计算器 (多周期加权)
    ↓
入场决策器 (评分系统)
    ↓
仓位管理器 (开仓/平仓)
    ↓
交易记录器 (保存数据)
    ↓
学习系统 (优化权重)
```

---

## 十二、关键文件

| 文件 | 功能 |
|------|------|
| `agent.py` | 核心交易Agent |
| `level_finder.py` | 支撑阻力位发现 |
| `sl_tp.py` | 止损止盈计算 |
| `exit_manager.py` | 平仓决策 |
| `indicators.py` | 技术指标计算 |
| `knowledge.py` | 交易记录与学习 |
| `app.py` | Flask Web服务 |

---

## 十三、性能指标

### 13.1 交易统计

- 总交易数
- 胜率（盈利交易 / 总交易）
- 盈亏比（总盈利 / 总亏损）
- 平均盈亏
- 最大连胜/连败

### 13.2 学习进度

- 当前阶段（探索/学习/稳定）
- 完成度（当前交易数 / 阶段目标）
- 特征权重调整次数
- 最有效特征排名

---

## 十四、实时监控

### 14.1 Web界面显示

- 4张K线图（1m/15m/8h/1w）
- 支撑阻力线标记
- 买入卖出标记
- 当前仓位状态
- 实时评分
- 学习进度条
- 运行日志

### 14.2 日志输出

```
[时间] 📊 BTC: $价格 | 趋势: 趋势 | RSI: RSI值 | 仓位: 当前/最大
[时间] 🟢 最佳支撑: 价格 (评分)
[时间] 🔴 最佳阻力: 价格 (评分)
[时间] 📍 仓位N: 方向 @ 价格 | 浮盈: 百分比%
[时间] 🚀 开仓 方向 @ 价格
[时间] ✅ 平仓 原因: 盈亏
```

---

## 十五、系统优化方向

1. **特征权重自动优化**：基于交易结果动态调整
2. **多策略融合**：支持多个独立策略并行
3. **风险管理**：动态调整杠杆和仓位大小
4. **市场适应**：根据市场波动性调整参数
5. **深度学习**：使用神经网络优化决策

---

**最后更新**：2026年1月8日
**系统版本**：v3.0（多仓位+渐进学习）
