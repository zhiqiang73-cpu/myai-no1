# å¼ºåŒ–å­¦ä¹ äº¤æ˜“ç³»ç»Ÿ - å®Œæ•´æ€ç»´æ ‘æ¶æ„

## ç³»ç»Ÿæ¦‚è§ˆ

è¿™æ˜¯ä¸€ä¸ªåŸºäºå¼ºåŒ–å­¦ä¹ çš„BTCæœŸè´§è‡ªåŠ¨äº¤æ˜“ç³»ç»Ÿï¼Œé‡‡ç”¨**æ„ŸçŸ¥-å†³ç­–-è¡ŒåŠ¨-å¥–åŠ±**çš„é—­ç¯æ¶æ„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¼ºåŒ–å­¦ä¹ äº¤æ˜“ç³»ç»Ÿ (RL Trading Agent)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚               â”‚
         [1.æ„ŸçŸ¥å±‚]        [2.å†³ç­–å±‚]      [3.æ‰§è¡Œå±‚]
              â”‚               â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                         [4.å¥–åŠ±å±‚]
                              â”‚
                       [5.å­¦ä¹ ä¸ä¼˜åŒ–]
```

---

## ç¬¬ä¸€å±‚ï¼šæ„ŸçŸ¥å±‚ (Perception)

**ç›®æ ‡**ï¼šç†è§£å¸‚åœºå½“å‰çŠ¶æ€

### 1.1 æ•°æ®é‡‡é›†
```
ä¸»ç½‘API â†’ 4ä¸ªæ—¶é—´å‘¨æœŸKçº¿
â”œâ”€â”€ 1åˆ†é’Ÿ  (çŸ­æœŸæ³¢åŠ¨ï¼Œå…¥åœºç²¾ç¡®åº¦)
â”œâ”€â”€ 15åˆ†é’Ÿ (å°è¶‹åŠ¿åˆ¤æ–­)
â”œâ”€â”€ 8å°æ—¶  (ä¸­æœŸè¶‹åŠ¿)
â””â”€â”€ 1å‘¨    (å¤§è¶‹åŠ¿æ–¹å‘)
```

### 1.2 æŠ€æœ¯æŒ‡æ ‡è®¡ç®— (`indicators.py`)
```python
for each timeframe:
    â”œâ”€â”€ EMA (7, 25, 99)      # è¶‹åŠ¿æ–¹å‘
    â”œâ”€â”€ RSI (14)             # è¶…ä¹°è¶…å–
    â”œâ”€â”€ MACD                 # åŠ¨é‡ç¡®è®¤
    â”œâ”€â”€ ATR                  # æ³¢åŠ¨ç‡
    â”œâ”€â”€ Volume Ratio         # æˆäº¤é‡å¼‚å¸¸
    â””â”€â”€ ADX + DI             # è¶‹åŠ¿å¼ºåº¦
```

### 1.3 è¶‹åŠ¿åˆ†æ (`agent.py::_analyze_trend`)
```
å®è§‚è¶‹åŠ¿ (Macro Trend - 8h+1w)
â”œâ”€â”€ æ–¹å‘: BULLISH/BEARISH/NEUTRAL
â”œâ”€â”€ å¼ºåº¦: ADXå€¼ (>25ä¸ºè¶‹åŠ¿ï¼Œ<15ä¸ºéœ‡è¡)
â”œâ”€â”€ ç±»å‹: STRONG_TREND / RANGING / WEAK_TREND
â””â”€â”€ å•è¾¹æ£€æµ‹: is_one_sided (é˜²æ­¢é€†åŠ¿)

å¾®è§‚è¶‹åŠ¿ (Micro Trend - 15m+1m)
â”œâ”€â”€ æ–¹å‘: BULLISH/BEARISH/NEUTRAL
â”œâ”€â”€ å¼ºåº¦: ADXå€¼
â””â”€â”€ ä»·æ ¼ç»“æ„: HH+HL(ä¸Šå‡) / LH+LL(ä¸‹é™)
```

### 1.4 æ”¯æ’‘é˜»åŠ›ä½è¯†åˆ« (`level_finder.py`)
**æ ¸å¿ƒç®—æ³•**ï¼šæ•´æ•°ä½ + æˆäº¤å¯†é›†åŒº + è¿‘æœŸé«˜ä½ç‚¹

```
Step 1: å€™é€‰ä»·ä½ç”Ÿæˆ
â”œâ”€â”€ æ•´æ•°ä½ (100, 500, 1000çš„å€æ•°)
â”œâ”€â”€ æˆäº¤é‡èŠ‚ç‚¹ (Volume Profile)
â””â”€â”€ æ‘†åŠ¨é«˜ä½ç‚¹ (Swing Levels)

Step 2: å¤šæ—¶é—´æ¡†æ¶ç¡®è®¤
for each candidate:
    score = 0
    if 1mæœ‰è§¦åŠ  â†’ +30åˆ†
    if 15mæœ‰è§¦åŠ â†’ +20åˆ†
    if 8hæœ‰è§¦åŠ  â†’ +15åˆ†
    if 1wæœ‰è§¦åŠ  â†’ +10åˆ†

Step 3: ç‰¹å¾è¯„åˆ† (`levels.py::LevelScoring`)
for each level:
    â”œâ”€â”€ è§¦åŠæ¬¡æ•° (è¶Šå¤šè¶Šå¼º)
    â”œâ”€â”€ åå¼¹å¼ºåº¦ (ä»·æ ¼ååº”)
    â”œâ”€â”€ æˆäº¤é‡èšé›†åº¦
    â”œâ”€â”€ æ—¶é—´æŒç»­æ€§
    â””â”€â”€ ç»¼åˆè¯„åˆ† â†’ é€‰æ‹©TOP 1æ”¯æ’‘ + TOP 1é˜»åŠ›
```

**æ„ŸçŸ¥-è¡ŒåŠ¨åˆ†ç¦»ä¼˜åŒ–** (Hybrid Cache):
```python
# æ”¯æ’‘é˜»åŠ›ä½æå‰5-20ç§’è®¡ç®—ï¼Œç»™å¸‚åœº"æ¶ˆåŒ–"æ—¶é—´
cached_levels = calculate_support_resistance(t-1)  # ä¸Šä¸€å¾ªç¯
current_price = fetch_latest_price(t)              # å½“å‰ä»·æ ¼
decision = make_decision(cached_levels, current_price)
```

---

## ç¬¬äºŒå±‚ï¼šå†³ç­–å±‚ (Decision)

**ç›®æ ‡**ï¼šåˆ¤æ–­æ˜¯å¦å…¥åœº/å‡ºåœºï¼Œä»¥åŠæ–¹å‘

### 2.1 å…¥åœºå†³ç­– (`agent.py::should_enter`)

**å¤šé‡ç¡®è®¤ç³»ç»Ÿ**ï¼š

```
å…¥åœºæ¡ä»¶é‡‘å­—å¡”:
                  [æ‰§è¡Œå…¥åœº]
                      â†‘
              [æ€»åˆ† â‰¥ é˜ˆå€¼(40-60åˆ†)]
                      â†‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    [åšå¤šä¿¡å·]                  [åšç©ºä¿¡å·]
        â†“                           â†“
```

#### åšå¤šè¯„åˆ†ç³»ç»Ÿ (æ»¡åˆ†100)
```python
long_score = 0
reasons = []

# 1. ä»·æ ¼æ¥è¿‘æœ€ä½³æ”¯æ’‘ä½ (30åˆ†)
if price near best_support:
    distance_score = f(distance)  # è¶Šè¿‘åˆ†æ•°è¶Šé«˜
    long_score += distance_score
    reasons.append("ä»·æ ¼æ¥è¿‘æ”¯æ’‘")

# 2. å®è§‚è¶‹åŠ¿ç¡®è®¤ (25åˆ†)
if macro_trend == BULLISH:
    long_score += 25
    reasons.append("å¤§è¶‹åŠ¿çœ‹å¤š")
elif macro_trend == WEAK_BULLISH:
    long_score += 15

# 3. RSIè¶…å– (15åˆ†)
if rsi_15m < 35:
    long_score += 15
    reasons.append("RSIè¶…å–")

# 4. MACDé‡‘å‰ (20åˆ†)
if macd_line > macd_signal and macd_hist > 0:
    long_score += 20
    reasons.append("MACDé‡‘å‰")

# 5. å¾®è§‚è¶‹åŠ¿é…åˆ (10åˆ†)
if micro_trend in [BULLISH, WEAK_BULLISH]:
    long_score += 10

# æ€»åˆ†åˆ¤æ–­
if long_score >= threshold:
    return {"direction": "LONG", "reason": reasons}
```

#### ğŸ›¡ï¸ é£é™©ä¿æŠ¤æœºåˆ¶
```python
# å•è¾¹è¡Œæƒ…ä¿æŠ¤
if macro_trend == STRONG_BEARISH:
    block_long_entry()  # ç¦æ­¢é€†åŠ¿åšå¤š
    
# è¶‹åŠ¿ä¸æ˜ä¿æŠ¤
if macro_trend == NEUTRAL and micro_trend == NEUTRAL:
    raise_threshold(+10åˆ†)  # æé«˜å…¥åœºé—¨æ§›

# æç«¯è¶‹åŠ¿æ•è·
if ADX >= 50:  # å•è¾¹è¡Œæƒ…
    relax_rsi_limit(from 70 to 85)  # æ”¾å®½RSIé™åˆ¶
```

### 2.2 å‡ºåœºå†³ç­– (`exit_manager.py`)

**å¤šç»´åº¦è¯„ä¼°ç³»ç»Ÿ**ï¼š

```
å‡ºåœºå†³ç­–æ ‘:
â”œâ”€â”€ [1] å›ºå®šæ­¢æŸ/æ­¢ç›ˆ (ä¼˜å…ˆçº§æœ€é«˜)
â”‚   â”œâ”€â”€ price <= stop_loss  â†’ ç«‹å³å¹³ä»“
â”‚   â””â”€â”€ price >= take_profit â†’ ç«‹å³å¹³ä»“
â”‚
â”œâ”€â”€ [2] åˆ†æ‰¹æ­¢ç›ˆ (TP1, TP2)
â”‚   â”œâ”€â”€ ç›ˆåˆ©è¾¾1% â†’ å¹³50%ï¼Œç§»åŠ¨æ­¢æŸåˆ°æˆæœ¬ä»·
â”‚   â””â”€â”€ ç›ˆåˆ©è¾¾2% â†’ å¹³å‰©ä½™50%
â”‚
â”œâ”€â”€ [3] ç§»åŠ¨æ­¢æŸ (Trailing Stop)
â”‚   â””â”€â”€ ç›ˆåˆ©è¶…è¿‡1% â†’ æ¿€æ´»è¿½è¸ªæ­¢æŸ
â”‚
â”œâ”€â”€ [4] åè½¬ä¿¡å·
â”‚   â”œâ”€â”€ RSIè¶…ä¹°/è¶…å–åè½¬
â”‚   â”œâ”€â”€ MACDæ­»å‰/é‡‘å‰åè½¬
â”‚   â””â”€â”€ è¶‹åŠ¿æ–¹å‘åè½¬ â†’ å¹³ä»“
â”‚
â”œâ”€â”€ [5] æ—¶é—´æ­¢æŸ (Time Stop)
â”‚   â””â”€â”€ æŒä»“è¶…è¿‡60åˆ†é’Ÿ â†’ å¼ºåˆ¶å¹³ä»“
â”‚
â””â”€â”€ [6] æœºä¼šæˆæœ¬æ›¿æ¢
    â””â”€â”€ æ–°æœºä¼šåˆ†æ•° > å½“å‰æŒä»“ Ã— 1.5 â†’ æ¢ä»“
```

#### æœºä¼šæˆæœ¬è¯„ä¼° (`evaluate_opportunity_cost`)
```python
# å½“å‰æŒä»“é¢„æœŸæ”¶ç›Š
current_expected = current_pnl_pct Ã— time_decay_factor

# æ–°æœºä¼šé¢„æœŸæ”¶ç›Š
new_win_rate = base_win_rate + (new_score - 30) / 10 Ã— 0.05
new_expected = new_win_rate Ã— avg_profit - (1-new_win_rate) Ã— avg_loss

# å†³ç­–
if new_expected > current_expected Ã— 1.5:
    return "SWITCH_POSITION"  # æ¢ä»“
```

---

## ç¬¬ä¸‰å±‚ï¼šæ‰§è¡Œå±‚ (Execution)

### 3.1 æ æ†è®¡ç®— (`agent.py::calculate_dynamic_leverage`)

**Kellyå…¬å¼æœ€ä¼˜ä»“ä½**ï¼š
```python
# Kellyå…¬å¼: f = (pÃ—b - q) / b
# p=èƒœç‡, q=è´¥ç‡, b=ç›ˆäºæ¯”

stats = trade_logger.get_stats()
win_rate = stats["win_rate"]
avg_profit = stats["avg_profit_percent"]
avg_loss = stats["avg_loss_percent"]

b = avg_profit / avg_loss
kelly = (win_rate Ã— b - (1 - win_rate)) / b

# Half-Kelly (æ›´ä¿å®ˆ)
optimal_leverage = base_leverage Ã— kelly Ã— 0.5
leverage = clamp(optimal_leverage, min=5, max=50)
```

**ä¿¡å·å¼ºåº¦è°ƒæ•´**ï¼š
```python
if signal_score >= 80:
    leverage Ã— 1.2  # å¼ºä¿¡å·åŠ ä»“
elif signal_score < 50:
    leverage Ã— 0.8  # å¼±ä¿¡å·å‡ä»“
```

### 3.2 æ­¢æŸæ­¢ç›ˆè®¡ç®— (`sl_tp_learner_v2.py`)

**ç¥ç»ç½‘ç»œé¢„æµ‹**ï¼š
```python
Input Features (17ç»´):
â”œâ”€â”€ ä»·æ ¼ç›¸å…³: è·æ”¯æ’‘/é˜»åŠ›è·ç¦», RSI, ATR
â”œâ”€â”€ è¶‹åŠ¿ç›¸å…³: ADX, è¶‹åŠ¿æ–¹å‘, è¶‹åŠ¿å¼ºåº¦
â”œâ”€â”€ å†å²ç»Ÿè®¡: å¹³å‡ç›ˆåˆ©%, å¹³å‡äºæŸ%, èƒœç‡
â””â”€â”€ å¸‚åœºçŠ¶æ€: æ³¢åŠ¨ç‡, MACD, Volume

Neural Network (3å±‚):
Input(17) â†’ Hidden(32) â†’ Hidden(16) â†’ Output(2)
                                        â”œâ”€â”€ SL%
                                        â””â”€â”€ TP%

Output: [å»ºè®®æ­¢æŸ%, å»ºè®®æ­¢ç›ˆ%]
èŒƒå›´: SL: 0.3%-1.5%, TP: 2%-8%
```

### 3.3 ä¸‹å•æ‰§è¡Œ (`agent.py::execute_entry`)

```python
def execute_entry(market, signal):
    # 1. è®¡ç®—åŠ¨æ€æ æ†
    leverage = calculate_dynamic_leverage(signal)
    
    # 2. é¢„æµ‹æ­¢æŸæ­¢ç›ˆ
    sl_tp = sl_tp_learner.predict(market_features)
    
    # 3. è®¡ç®—ä»“ä½å¤§å°
    quantity = calculate_quantity(leverage, price)
    
    # 4. ä¸‹å¸‚ä»·å•
    order = client.place_order(
        symbol="BTCUSDT",
        side="BUY" if signal["direction"] == "LONG" else "SELL",
        type="MARKET",
        quantity=quantity
    )
    
    # 5. ä¿å­˜æŒä»“è®°å½•
    position = {
        "trade_id": uuid(),
        "direction": signal["direction"],
        "entry_price": order["avgPrice"],
        "quantity": quantity,
        "leverage": leverage,
        "stop_loss": sl_tp["stop_loss"],
        "take_profit": sl_tp["take_profit"],
        "timestamp_open": now(),
        "entry_features": market_features  # ç”¨äºåç»­å­¦ä¹ 
    }
    positions.append(position)
    
    return position
```

---

## ç¬¬å››å±‚ï¼šå¥–åŠ±å±‚ (Reward)

**ç›®æ ‡**ï¼šé‡åŒ–äº¤æ˜“ç»“æœï¼Œæä¾›å­¦ä¹ ä¿¡å·

### 4.1 ç›ˆäºè®¡ç®—
```python
# å¹³ä»“æ—¶è®¡ç®—
pnl = (exit_price - entry_price) Ã— quantity  # LONG
pnl_percent = (exit_price - entry_price) / entry_price Ã— 100

is_win = pnl > 0
hold_duration = (timestamp_close - timestamp_open).minutes
```

### 4.2 å½’å› åˆ†æ (Attribution)

**åˆ†ç¦»å„æ¨¡å—çš„è´¡çŒ®**ï¼š

```
äº¤æ˜“ç»“æœ â†’ æ‹†è§£å½±å“å› ç´ 
â”œâ”€â”€ [å…¥åœºè´¨é‡] Entry Score
â”‚   â”œâ”€â”€ ä»·ä½é€‰æ‹©æ˜¯å¦å‡†ç¡®ï¼Ÿ
â”‚   â”œâ”€â”€ è¶‹åŠ¿åˆ¤æ–­æ˜¯å¦æ­£ç¡®ï¼Ÿ
â”‚   â””â”€â”€ æ—¶æœºæŠŠæ¡æ˜¯å¦æ°å½“ï¼Ÿ
â”‚
â”œâ”€â”€ [æ­¢æŸæ­¢ç›ˆ] SL/TP Quality
â”‚   â”œâ”€â”€ æ­¢æŸè®¾ç½®æ˜¯å¦åˆç†ï¼Ÿ
â”‚   â”œâ”€â”€ æ­¢ç›ˆç›®æ ‡æ˜¯å¦è¿‡äºæ¿€è¿›ï¼Ÿ
â”‚   â””â”€â”€ æ˜¯å¦è¢«ä¸å¿…è¦çš„æ­¢æŸæ‰«å‡ºï¼Ÿ
â”‚
â”œâ”€â”€ [å‡ºåœºæ—¶æœº] Exit Timing
â”‚   â”œâ”€â”€ æ˜¯å¦è¿‡æ—©å¹³ä»“é”™å¤±åˆ©æ¶¦ï¼Ÿ
â”‚   â”œâ”€â”€ æ˜¯å¦æŒä»“è¿‡ä¹…å¯¼è‡´å›æ’¤ï¼Ÿ
â”‚   â””â”€â”€ åè½¬ä¿¡å·æ˜¯å¦åŠæ—¶æ•æ‰ï¼Ÿ
â”‚
â””â”€â”€ [æ”¯æ’‘é˜»åŠ›ä½] Level Effectiveness
    â”œâ”€â”€ ä»·ä½æ˜¯å¦çœŸå®èµ·åˆ°æ”¯æ’‘/é˜»åŠ›ä½œç”¨ï¼Ÿ
    â””â”€â”€ ä»·ä½è¢«çªç ´åçš„ååº”
```

### 4.3 æ€ç»´é“¾è®°å½• (`ThoughtChain`)

**å®Œæ•´è®°å½•å†³ç­–è¿‡ç¨‹**ï¼š
```python
thought_chain = {
    "perception": {
        "macro_direction": "BULLISH",
        "macro_adx": 38.5,
        "micro_direction": "WEAK_BULLISH",
        "price_structure": "UPTREND",
        "best_support": 91820,
        "best_resistance": 92500
    },
    "action": {
        "direction": "LONG",
        "entry_price": 91850,
        "leverage": 10,
        "stop_loss": 91550,
        "take_profit": 92800,
        "confirmations": [
            "ä»·æ ¼æ¥è¿‘æ”¯æ’‘(91820)",
            "å¤§è¶‹åŠ¿çœ‹å¤š(ADX=38)",
            "RSIè¶…å–(33)",
            "MACDé‡‘å‰"
        ]
    },
    "reward": {
        "pnl": 148.05,
        "pnl_percent": 0.29,
        "exit_reason": "MANUAL",
        "hold_duration": 2,
        "level_score_change": {
            "support_91820": "æœ‰æ•ˆ(+5åˆ†)"
        }
    }
}
```

---

## ç¬¬äº”å±‚ï¼šå­¦ä¹ ä¸ä¼˜åŒ–

### 5.1 æ”¯æ’‘é˜»åŠ›ä½å­¦ä¹  (`level_finder.py`)

**ç»Ÿè®¡æœ‰æ•ˆæ€§**ï¼š
```python
for each level used:
    if price_bounced_at_level:
        level.effectiveness_score += 1
        level.weight += 0.1
    else:
        level.effectiveness_score -= 1
        level.weight Ã— 0.9

# é•¿æœŸç»Ÿè®¡
level_stats = {
    "level_91800": {
        "total_tests": 15,
        "successful_bounces": 12,
        "effectiveness_rate": 80%,
        "current_weight": 1.8
    }
}
```

### 5.2 å…¥åœºç­–ç•¥å­¦ä¹  (`entry_learner_v2.py`)

**ç»éªŒå›æ”¾ (Experience Replay)**ï¼š
```python
# è®°å½•æ¯æ¬¡å…¥åœºå†³ç­–
entry_memory = {
    "features": market_features,
    "score": 65,
    "action": "LONG",
    "result": {
        "pnl_percent": 0.29,
        "max_adverse": -0.05,  # æœ€å¤§ä¸åˆ©æ³¢åŠ¨
        "max_favorable": 0.35   # æœ€å¤§æœ‰åˆ©æ³¢åŠ¨
    }
}

# è®­ç»ƒç¥ç»ç½‘ç»œä¼˜åŒ–è¯„åˆ†
neural_network.train(
    input=features,
    target=actual_quality_score
)
```

### 5.3 æ­¢æŸæ­¢ç›ˆä¼˜åŒ– (`sl_tp_learner_v2.py`)

**åå‘ä¼ æ’­ä¼˜åŒ–**ï¼š
```python
for trade in history:
    # å®é™…æœ€ä¼˜æ­¢æŸæ­¢ç›ˆ
    optimal_sl = trade["lowest_price"] Ã— 0.995  # ç¨ç•™ä½™åœ°
    optimal_tp = trade["highest_price"] Ã— 0.995
    
    # å½“æ—¶é¢„æµ‹çš„æ­¢æŸæ­¢ç›ˆ
    predicted_sl, predicted_tp = model.predict(trade["entry_features"])
    
    # è®¡ç®—æŸå¤±
    loss = mse(predicted_sl, optimal_sl) + mse(predicted_tp, optimal_tp)
    
    # åå‘ä¼ æ’­æ›´æ–°æƒé‡
    model.backward(loss)
```

### 5.4 åŠ¨æ€ç›®æ ‡ä¼˜åŒ– (`target_optimizer.py`)

**åˆ†é˜¶æ®µæå‡ç³»ç»Ÿ**ï¼š
```python
Stages:
â”œâ”€â”€ Stage 1: æ¢ç´¢æœŸ (0-20ç¬”)
â”‚   â”œâ”€â”€ ç›®æ ‡èƒœç‡: â‰¥50%
â”‚   â”œâ”€â”€ ç›®æ ‡ç›ˆäºæ¯”: â‰¥1.5:1
â”‚   â””â”€â”€ å…¥åœºé˜ˆå€¼: 40åˆ†
â”‚
â”œâ”€â”€ Stage 2: å­¦ä¹ æœŸ (20-50ç¬”)
â”‚   â”œâ”€â”€ ç›®æ ‡èƒœç‡: â‰¥52%
â”‚   â”œâ”€â”€ ç›®æ ‡ç›ˆäºæ¯”: â‰¥1.8:1
â”‚   â””â”€â”€ å…¥åœºé˜ˆå€¼: 45åˆ†
â”‚
â”œâ”€â”€ Stage 3: ä¼˜åŒ–æœŸ (50-100ç¬”)
â”‚   â”œâ”€â”€ ç›®æ ‡èƒœç‡: â‰¥55%
â”‚   â”œâ”€â”€ ç›®æ ‡ç›ˆäºæ¯”: â‰¥2.0:1
â”‚   â””â”€â”€ å…¥åœºé˜ˆå€¼: 50åˆ†
â”‚
â””â”€â”€ Stage 4: ç¨³å®šæœŸ (100+ç¬”)
    â”œâ”€â”€ ç›®æ ‡èƒœç‡: â‰¥58%
    â”œâ”€â”€ ç›®æ ‡ç›ˆäºæ¯”: â‰¥2.2:1
    â””â”€â”€ å…¥åœºé˜ˆå€¼: 55åˆ†

# è‡ªåŠ¨å‡çº§
if current_win_rate >= target and trades >= min_trades:
    upgrade_to_next_stage()
```

---

## ç¬¬å…­å±‚ï¼šé£é™©æ§åˆ¶

### 6.1 ä»“ä½ç®¡ç†
```python
MAX_POSITIONS = 3  # æœ€å¤š3ä¸ªå¹¶å‘æŒä»“
MAX_RISK_PER_TRADE = 2%  # å•ç¬”æœ€å¤§é£é™©
MAX_TOTAL_RISK = 5%  # æ€»é£é™©é™åˆ¶

# å‡¯åˆ©å‡†åˆ™
kelly_fraction = (win_rate Ã— avg_win - (1-win_rate) Ã— avg_loss) / avg_win
position_size = kelly_fraction Ã— 0.5  # Half-Kelly
```

### 6.2 å›æ’¤ç›‘æ§
```python
# å¤æ™®æ¯”ç‡ç›‘æ§
sharpe_ratio = mean_return / std_return Ã— sqrt(252)

if sharpe_ratio < -1:
    alert("é£é™©è¿‡é«˜ï¼Œç«‹å³åœæ­¢äº¤æ˜“")
    stop_agent()
```

### 6.3 æ‰‹åŠ¨å¹³ä»“æ£€æµ‹
```python
# æ¯ä¸ªå¾ªç¯æ£€æµ‹äº¤æ˜“æ‰€å®é™…æŒä»“
exchange_qty = get_exchange_position()
system_qty = sum(pos["quantity"] for pos in positions)

if exchange_qty < system_qty Ã— 0.95:  # å…è®¸5%è¯¯å·®
    # éƒ¨åˆ†å¹³ä»“æ£€æµ‹
    record_manual_close(system_qty - exchange_qty)
```

---

## ç¬¬ä¸ƒå±‚ï¼šç›‘æ§ä¸å¯è§†åŒ–

### 7.1 Webç•Œé¢ (`app.py`)
```
Flaskåç«¯:
â”œâ”€â”€ /api/klines          # Kçº¿æ•°æ®
â”œâ”€â”€ /api/positions       # æŒä»“çŠ¶æ€
â”œâ”€â”€ /api/agent/trades    # äº¤æ˜“å†å²
â”œâ”€â”€ /api/agent/status    # AgentçŠ¶æ€
â”œâ”€â”€ /api/agent/levels    # æ”¯æ’‘é˜»åŠ›ä½
â””â”€â”€ /api/agent/thoughts  # æ€ç»´é“¾
```

### 7.2 å®æ—¶æ—¥å¿—
```python
Log Types:
â”œâ”€â”€ [PERCEPTION] æ„ŸçŸ¥å±‚æ—¥å¿—ï¼ˆå¸‚åœºçŠ¶æ€ï¼‰
â”œâ”€â”€ [SIGNAL] ä¿¡å·å‘ç°
â”œâ”€â”€ [ENTRY] å…¥åœºæ‰§è¡Œ
â”œâ”€â”€ [EXIT] å‡ºåœºæ‰§è¡Œ
â”œâ”€â”€ [AI] å­¦ä¹ è¿›åº¦
â””â”€â”€ [WARN] é£é™©è­¦å‘Š
```

### 7.3 Kçº¿å›¾æ ‡è®°
```javascript
// å…¥åœºæ ‡è®°
if (trade.direction === 'LONG') {
    marker = {
        color: green,
        shape: arrowUp,
        text: 'ä¹°å…¥ @ 91850'
    }
}

// å‡ºåœºæ ‡è®°
if (trade.pnl > 0) {
    marker = {
        color: green,
        text: 'æ­¢ç›ˆ +148 USDT'
    }
}
```

---

## æ•°æ®æµç¤ºæ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Binance    â”‚
â”‚  Futures APIâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (K-line data)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Perception Layer (æ„ŸçŸ¥å±‚)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚Indicatorsâ”‚â†’ â”‚Trend     â”‚â†’ â”‚Support   â”‚      â”‚
â”‚  â”‚åˆ†æ      â”‚  â”‚Analysis  â”‚  â”‚Resistanceâ”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ (market_state)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Decision Layer (å†³ç­–å±‚)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚should    â”‚  â”‚check     â”‚                    â”‚
â”‚  â”‚enter()   â”‚  â”‚exit()    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚       â”‚signal       â”‚decision                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Execution Layer (æ‰§è¡Œå±‚)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Leverage  â”‚â†’ â”‚SL/TP     â”‚â†’ â”‚Place     â”‚     â”‚
â”‚  â”‚Calc      â”‚  â”‚Predict   â”‚  â”‚Order     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ (position)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Reward Layer (å¥–åŠ±å±‚)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚PnL Calc  â”‚â†’ â”‚Attributionâ”‚â†’ â”‚Thought   â”‚     â”‚
â”‚  â”‚          â”‚  â”‚Analysis   â”‚  â”‚Chain     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ (feedback)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Learning Layer (å­¦ä¹ ä¼˜åŒ–å±‚)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Level     â”‚  â”‚Entry     â”‚  â”‚SL/TP     â”‚     â”‚
â”‚  â”‚Learning  â”‚  â”‚Learning  â”‚  â”‚Learning  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                      â†‘                          â”‚
â”‚              (update weights)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®è®¾è®¡ç†å¿µ

### 1. æ„ŸçŸ¥-è¡ŒåŠ¨åˆ†ç¦»
- æ”¯æ’‘é˜»åŠ›ä½è®¡ç®—æå‰è¿›è¡Œï¼Œç»™å¸‚åœº"æ¶ˆåŒ–"æ—¶é—´
- é¿å…ç¬æ—¶ä»·æ ¼æ³¢åŠ¨å¯¼è‡´çš„è¯¯åˆ¤

### 2. å¤šé‡ç¡®è®¤
- ä¸ä¾èµ–å•ä¸€æŒ‡æ ‡
- è¶‹åŠ¿ + ä»·ä½ + æŒ‡æ ‡ + æˆäº¤é‡ å¤šç»´åº¦ç¡®è®¤

### 3. åˆ†ç¦»å½’å› 
- æ¯ä¸ªæ¨¡å—ç‹¬ç«‹è¯„ä¼°æ•ˆæœ
- é’ˆå¯¹æ€§ä¼˜åŒ–ï¼Œé¿å…ç›¸äº’å¹²æ‰°

### 4. åŠ¨æ€é€‚åº”
- Kellyå…¬å¼åŠ¨æ€è°ƒæ•´æ æ†
- ç¥ç»ç½‘ç»œå­¦ä¹ æœ€ä¼˜SL/TP
- é˜¶æ®µæ€§æå‡ç›®æ ‡

### 5. é£é™©ä¼˜å…ˆ
- æ­¢æŸæ°¸è¿œç¬¬ä¸€ä¼˜å…ˆçº§
- ä»“ä½é™åˆ¶å’Œå›æ’¤ç›‘æ§
- æ‰‹åŠ¨å¹³ä»“æ£€æµ‹å’Œè®°å½•

---

## æ–‡ä»¶ç»“æ„å¯¹ç…§

```
binance-futures-trading/
â”œâ”€â”€ rl/
â”‚   â”œâ”€â”€ agent.py                  # ä¸»Agentï¼ˆæ„ŸçŸ¥+å†³ç­–+æ‰§è¡Œï¼‰
â”‚   â”œâ”€â”€ indicators.py             # æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
â”‚   â”œâ”€â”€ level_finder.py           # æ”¯æ’‘é˜»åŠ›ä½è¯†åˆ«
â”‚   â”œâ”€â”€ levels.py                 # ä»·ä½è¯„åˆ†ç³»ç»Ÿ
â”‚   â”œâ”€â”€ exit_manager.py           # å‡ºåœºå†³ç­–ç®¡ç†
â”‚   â”œâ”€â”€ entry_learner_v2.py       # å…¥åœºç­–ç•¥å­¦ä¹ 
â”‚   â”œâ”€â”€ sl_tp_learner_v2.py       # æ­¢æŸæ­¢ç›ˆå­¦ä¹ 
â”‚   â”œâ”€â”€ target_optimizer.py       # åŠ¨æ€ç›®æ ‡ä¼˜åŒ–
â”‚   â””â”€â”€ knowledge.py              # äº¤æ˜“æ—¥å¿—å­˜å‚¨
â”‚
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ app.py                    # Flaskåç«¯API
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ index.html            # å‰ç«¯ç•Œé¢
â”‚
â”œâ”€â”€ client.py                     # Binance APIå°è£…
â””â”€â”€ config.py                     # é…ç½®æ–‡ä»¶
```

---

## æ€§èƒ½æŒ‡æ ‡

å½“å‰ç³»ç»Ÿç›®æ ‡ï¼ˆStage 1ï¼‰ï¼š
- âœ… èƒœç‡ â‰¥ 50%
- âœ… ç›ˆäºæ¯” â‰¥ 1.5:1
- âœ… å¤æ™®æ¯”ç‡ > 0
- âœ… æœ€å¤§å›æ’¤ < 10%

é•¿æœŸç›®æ ‡ï¼ˆStage 4ï¼‰ï¼š
- ğŸ¯ èƒœç‡ â‰¥ 58%
- ğŸ¯ ç›ˆäºæ¯” â‰¥ 2.2:1
- ğŸ¯ å¤æ™®æ¯”ç‡ > 1.5
- ğŸ¯ æœ€å¤§å›æ’¤ < 5%

---

**æœ€åæ›´æ–°**: 2026-01-14
**ç‰ˆæœ¬**: v3.0
