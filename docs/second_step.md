# Second Step - 强化学习交易系统存档

> 存档时间: 2026年1月9日
> 版本: v2.0 - 渐进式学习系统

---

## 一、系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        Web界面 (Flask)                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │ K线图表  │ │ 账户信息 │ │ 持仓管理 │ │ 训练进度可视化   │   │
│  │ (4周期)  │ │ 余额显示 │ │ 止盈止损 │ │ 特征权重条形图   │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      TradingAgent 核心                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    决策流程                              │   │
│  │  感知 → 分析 → 决策 → 执行 → 记录 → 学习               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ 技术指标分析 │  │ 支撑阻力发现 │  │ 渐进式入场门槛       │  │
│  │ RSI/MACD/BB  │  │ 6特征评分    │  │ 探索期→学习期→稳定期 │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据层                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ 币安主网API  │  │ 币安测试网   │  │ SQLite数据库         │  │
│  │ (实时K线)    │  │ (模拟交易)   │  │ (交易记录/学习数据)  │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、核心模块说明

### 2.1 文件结构

```
binance-futures-trading/
├── web/
│   ├── app.py              # Flask主应用，Agent控制循环
│   └── templates/
│       └── index.html      # 前端界面，K线图表，训练进度可视化
├── rl/
│   ├── __init__.py         # 模块导出
│   ├── agent.py            # 交易Agent核心，决策逻辑
│   ├── indicators.py       # 技术指标计算 (RSI/MACD/BB/ATR)
│   ├── levels.py           # 支撑阻力位发现
│   ├── level_finder.py     # 最佳价位发现器，6特征评分系统
│   ├── sl_tp.py            # 止盈止损计算，仓位管理
│   ├── knowledge.py        # 知识库，交易日志，统计分析
│   └── exit_manager.py     # 智能平仓管理
├── client.py               # 币安API客户端
├── config.py               # 配置文件
├── 启动程序.bat            # 启动脚本
└── docs/                   # 文档目录
```

### 2.2 关键模块详解

#### TradingAgent (agent.py)
```python
class TradingAgent:
    """
    核心交易Agent
    
    流程:
    1. analyze_market() - 多周期市场分析
    2. should_enter() - 入场信号判断（渐进式门槛）
    3. execute_entry() - 执行开仓
    4. check_exit() - 检查平仓条件
    5. execute_exit() - 执行平仓
    """
```

#### BestLevelFinder (level_finder.py)
```python
# 6个特征权重（初始值）
DEFAULT_WEIGHTS = {
    "volume_density": 0.20,        # 成交量密集度
    "touch_bounce_count": 0.20,    # 触及反弹次数
    "bounce_magnitude": 0.15,      # 反弹幅度
    "failed_breakout_count": 0.20, # 假突破次数
    "duration_days": 0.10,         # 持续天数
    "multi_tf_confirm": 0.15,      # 多周期确认
}
```

---

## 三、核心算法逻辑

### 3.1 渐进式入场门槛

```python
# 根据交易次数动态调整入场要求
trade_count = self.trade_logger.get_trade_count()

if trade_count < 30:
    # 探索期：低门槛，多交易，快速收集数据
    min_score = 35
    score_diff = 10
    phase = "探索期"
elif trade_count < 100:
    # 学习期：逐渐提高门槛
    min_score = 45
    score_diff = 12
    phase = "学习期"
else:
    # 稳定期：正常门槛
    min_score = 55
    score_diff = 15
    phase = "稳定期"
```

| 阶段 | 交易次数 | 入场门槛 | 多空分差 | 目的 |
|------|---------|---------|---------|------|
| 探索期 | 0-30笔 | 35分 | 10分 | 快速收集数据 |
| 学习期 | 30-100笔 | 45分 | 12分 | 开始优化权重 |
| 稳定期 | 100+笔 | 55分 | 15分 | 稳定盈利 |

### 3.2 多周期支撑阻力权重（短线优化）

```python
# 权重分配（短线交易优化）
# - 15分钟确认：60%（最重要，匹配交易周期）
# - 8小时确认：30%
# - 周线确认：10%

min15_score = 0.6 if touch_count >= 3 else 0.0
hour8_score = 0.3 if touch_count >= 2 else 0.0
week_score = 0.1 if touch_count >= 1 else 0.0
```

### 3.3 入场信号评分系统

```python
# 6项确认指标，总分100分
# 1. 大趋势确认 (25分) - 周线+8H方向
# 2. 支撑/阻力位确认 (25分) - 最佳价位评分
# 3. RSI确认 (15分) - 超买超卖
# 4. MACD确认 (20分) - 金叉死叉
# 5. 布林带确认 (15分) - 位置判断
# 6. 成交量确认 (5分) - 放量确认
```

### 3.4 思维链记录

```python
class ThoughtChain:
    """
    记录每笔交易的完整决策过程
    
    结构:
    - perception: 感知（市场状态、指标值）
    - action: 行动（方向、价格、止盈止损）
    - reward: 奖励（盈亏、评分变化）
    - summary: 一句话总结
    """
```

---

## 四、数据流程

### 4.1 K线数据获取

```
主网 (fapi.binance.com) → 实时K线数据
    ↓
4个周期: 1m, 15m, 8h, 1w
    ↓
技术指标计算 (RSI, MACD, BB, ATR, EMA)
    ↓
支撑阻力位发现 (6特征评分)
    ↓
入场信号判断
```

### 4.2 交易执行

```
测试网 (testnet.binancefuture.com) → 模拟交易
    ↓
限价单 + IOC (避免滑点)
    ↓
持仓跟踪 (PositionState)
    ↓
智能平仓 (分批止盈/移动止损)
    ↓
交易记录 (SQLite)
```

---

## 五、Web界面功能

### 5.1 K线图表
- 4个周期同步显示 (1m, 15m, 8h, 1w)
- 支撑/阻力线实时标注
- 时间格式根据周期自适应

### 5.2 账户信息
- 总额 / 可用 / 占用（保证金）
- 实时刷新

### 5.3 训练进度可视化
```
┌─────────────────────────────────────┐
│ 📊 特征训练进度                     │
├─────────────────────────────────────┤
│ 探索期  5/30笔                      │
│ ████████░░░░░░░░░░░░ 17%           │
├─────────────────────────────────────┤
│ 成交量密集  ████████░░░░  20%      │
│ 触及反弹    ████████░░░░  20%      │
│ 反弹幅度    ██████░░░░░░  15%      │
│ 假突破      ████████░░░░  20%      │
│ 持续天数    ████░░░░░░░░  10%      │
│ 多周期确认  ██████░░░░░░  15%      │
└─────────────────────────────────────┘
```

### 5.4 运行日志
- 实时显示Agent决策过程
- 显示当前评分和入场门槛
- 格式: `⏳ 观望中 | 做多:42 做空:25 (需≥35分) [探索期|5笔]`

---

## 六、API接口

### 6.1 Agent控制
```
POST /api/agent/start   - 启动Agent
POST /api/agent/stop    - 停止Agent
GET  /api/agent/status  - 获取状态（含学习进度）
GET  /api/agent/logs    - 获取日志
GET  /api/agent/levels  - 获取支撑阻力位
```

### 6.2 账户操作
```
GET  /api/account       - 账户余额
GET  /api/positions     - 持仓信息
POST /api/order         - 下单
POST /api/close         - 平仓
```

### 6.3 数据获取
```
GET  /api/klines/<symbol>/<interval>  - 单周期K线
GET  /api/klines_all/<symbol>         - 全周期K线
```

---

## 七、配置说明

### 7.1 环境变量 (.env)
```
API_KEY=你的测试网API密钥
API_SECRET=你的测试网API密钥
```

### 7.2 关键参数
```python
# agent.py
leverage = 10           # 杠杆倍数
max_risk_percent = 2.0  # 单笔最大风险

# level_finder.py
MIN_TRADES_FOR_ADJUST = 30  # 开始调整权重的最小交易数

# app.py
检查间隔: 有持仓30秒，无持仓60秒
```

---

## 八、启动方式

### 方式1: 批处理文件
```batch
# 启动程序.bat
cd /d "%~dp0"
python -m web.app
```

### 方式2: 命令行
```bash
cd binance-futures-trading
python -m web.app
```

访问: http://localhost:5000

---

## 九、学习系统工作原理

### 9.1 特征学习流程
```
1. 发现候选支撑/阻力位
2. 计算每个价位的6个特征值
3. 用当前权重计算综合得分
4. 选择最佳价位进行交易
5. 记录交易结果（盈亏）
6. 统计分析特征有效性
7. 基于统计微调权重（30+笔后）
8. 循环迭代
```

### 9.2 权重调整逻辑
```python
# 只有在足够数据后才调整
if total_trades >= MIN_TRADES_FOR_ADJUST:
    # 分析每个特征与盈利的相关性
    # 有效特征：权重+5%
    # 无效特征：权重-5%
    # 保持权重总和为1
```

---

## 十、已解决的问题

1. ✅ 风险收益比检查导致无法开仓 - 移除检查，显示具体错误
2. ✅ API超时问题 - 添加30秒超时和3次重试
3. ✅ 测试网滑点问题 - 使用限价单+IOC
4. ✅ 交易信号太少 - 渐进式入场门槛
5. ✅ 支撑阻力位太粗 - 调整为15分钟为主(60%)
6. ✅ K线时间显示错误 - 根据周期自适应格式
7. ✅ 看不到保证金占用 - 显示总额/可用/占用

---

## 十一、后续优化方向

1. 增加更多技术指标（KDJ、VWAP等）
2. 支持多币种交易
3. 添加回测功能
4. 优化权重学习算法（贝叶斯优化）
5. 添加风险控制（最大回撤限制）
6. 支持实盘交易（需谨慎）

---

## 十二、复制部署步骤

1. 复制整个 `binance-futures-trading` 目录
2. 安装依赖: `pip install flask requests`
3. 配置 `.env` 文件（API密钥）
4. 运行 `启动程序.bat` 或 `python -m web.app`
5. 访问 http://localhost:5000

---

*文档结束 - Second Step 存档完成*
