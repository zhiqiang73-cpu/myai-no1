# æœºä¼šæˆæœ¬ä¼˜åŒ– ğŸ¯

## æ ¸å¿ƒç†å¿µ

çŸ­çº¿äº¤æ˜“çš„æœ¬è´¨æ˜¯**æ—¶é—´å˜ç°**ã€‚æ¯ä¸€ç§’æŒä»“éƒ½æœ‰æˆæœ¬ï¼š

```
æœºä¼šæˆæœ¬ = æ”¾å¼ƒå…¶ä»–æ›´å¥½æœºä¼šçš„æ½œåœ¨æ”¶ç›Š
```

### ä½ çš„åŸè¯

> å½“ç³»ç»Ÿå‘ç°ç°æœ‰æŒä»“çš„æ”¶ç›Šå°äºå¹³ä»“åå»æŠ“ä¸‹ä¸€æ³¢çš„æ—¶å€™ï¼Œ
> å°±è¯¥æœæ–­å¹³ä»“å»æŠ“ä¸‹ä¸€æ³¢ï¼Œè€Œä¸æ˜¯ä¸€ç›´æŒä»“ç­‰å¾…ã€‚

---

## å®ç°é€»è¾‘

### å†³ç­–å…¬å¼

```python
å½“å‰æŒä»“é¢„æœŸæ”¶ç›Š = å½“å‰æµ®ç›ˆ + å‰©ä½™ä¸Šæ¶¨ç©ºé—´ Ã— åˆ°è¾¾æ¦‚ç‡

æ–°æœºä¼šé¢„æœŸæ”¶ç›Š = èƒœç‡ Ã— å¹³å‡ç›ˆåˆ© + (1-èƒœç‡) Ã— å¹³å‡äºæŸ - äº¤æ˜“æˆæœ¬

if æ–°æœºä¼šé¢„æœŸæ”¶ç›Š > å½“å‰é¢„æœŸæ”¶ç›Š Ã— 1.5:  # 1.5å€é˜ˆå€¼
    å¹³ä»“ â†’ å¼€æ–°ä»“
```

### å…³é”®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | å«ä¹‰ |
|------|--------|------|
| `opportunity_threshold` | 1.5 | æ–°æœºä¼šéœ€è¦æ¯”å½“å‰å¥½å¤šå°‘å€æ‰åˆ‡æ¢ |
| `min_profit_to_switch` | 0.3% | è‡³å°‘ç›ˆåˆ©å¤šå°‘æ‰è€ƒè™‘åˆ‡æ¢ï¼ˆè¦†ç›–æ‰‹ç»­è´¹ï¼‰|
| `trading_cost` | 0.1% | äº¤æ˜“æˆæœ¬ï¼ˆæ‰‹ç»­è´¹+æ»‘ç‚¹ï¼‰|

---

## æ¦‚ç‡è®¡ç®—

### åˆ°è¾¾æ­¢ç›ˆçš„æ¦‚ç‡

```python
# åŸºç¡€æ¦‚ç‡å–å†³äºè¶‹åŠ¿
if è¶‹åŠ¿é¡ºåŠ¿:
    base_prob = 0.5 + trend_strength Ã— 0.3  # 50%-80%
else:
    base_prob = 0.3 - trend_strength Ã— 0.1  # 20%-30%

# è·ç¦»è¡°å‡ï¼šè·ç¦»è¶Šè¿œï¼Œæ¦‚ç‡è¶Šä½
distance_decay = max(0.2, 1 - å‰©ä½™è·ç¦»% / 5)

åˆ°è¾¾æ¦‚ç‡ = base_prob Ã— distance_decay
```

### æ–°æœºä¼šçš„é¢„æœŸæ”¶ç›Š

```python
# åŸºäºå†å²ç»Ÿè®¡
avg_profit = å†å²å¹³å‡ç›ˆåˆ©%
win_rate = å†å²èƒœç‡
avg_loss = å†å²å¹³å‡äºæŸ%

# åˆ†æ•°è¶Šé«˜ï¼Œé¢„æœŸèƒœç‡è¶Šé«˜
score_bonus = (å…¥åœºåˆ†æ•° - 30) / 10 Ã— 0.05
adjusted_win_rate = min(0.8, win_rate + score_bonus)

# é¢„æœŸæ”¶ç›Š
expected = adjusted_win_rate Ã— avg_profit + (1-adjusted_win_rate) Ã— avg_loss - äº¤æ˜“æˆæœ¬
```

---

## å®é™…æ•ˆæœç¤ºä¾‹

### åœºæ™¯1ï¼šåº”è¯¥åˆ‡æ¢

```
å½“å‰æŒä»“ï¼š
- æ–¹å‘: LONG
- æµ®ç›ˆ: 0.5%
- è·ç¦»æ­¢ç›ˆ: 2%
- è¶‹åŠ¿: è½¬å¼±

æ–°æœºä¼šï¼š
- æ–¹å‘: SHORT
- å…¥åœºåˆ†æ•°: 65åˆ†
- è¶‹åŠ¿: å¼ºåŠ¿ä¸‹è·Œ

è®¡ç®—ï¼š
- å½“å‰é¢„æœŸæ”¶ç›Š = 0.5% + 2% Ã— 0.3 = 1.1%
- æ–°æœºä¼šé¢„æœŸæ”¶ç›Š = 0.7 Ã— 1.2% + 0.3 Ã— (-0.4%) - 0.1% = 0.62%
  ï¼ˆä½†æ–°æœºä¼šè¶‹åŠ¿æ›´å¼ºï¼Œå®é™…è°ƒæ•´åæ›´é«˜ï¼‰

å†³ç­–ï¼šåˆ‡æ¢ï¼
```

### åœºæ™¯2ï¼šä¸åº”è¯¥åˆ‡æ¢

```
å½“å‰æŒä»“ï¼š
- æ–¹å‘: LONG
- æµ®ç›ˆ: 1.5%
- è·ç¦»æ­¢ç›ˆ: 0.5%
- è¶‹åŠ¿: å¼ºåŠ¿

æ–°æœºä¼šï¼š
- æ–¹å‘: SHORT
- å…¥åœºåˆ†æ•°: 35åˆ†ï¼ˆè¾ƒä½ï¼‰

è®¡ç®—ï¼š
- å½“å‰é¢„æœŸæ”¶ç›Š = 1.5% + 0.5% Ã— 0.7 = 1.85%
- æ–°æœºä¼šé¢„æœŸæ”¶ç›Š = 0.45 Ã— 0.8% + 0.55 Ã— (-0.4%) - 0.1% = 0.04%

å†³ç­–ï¼šç»§ç»­æŒæœ‰ï¼å½“å‰æ›´å¥½ã€‚
```

---

## ä»£ç ä½ç½®

### ExitManager.evaluate_opportunity_cost()

```python
# è®¡ç®—æœºä¼šæˆæœ¬
result = exit_manager.evaluate_opportunity_cost(
    state=position_state,
    current_price=current_price,
    market_state=market_state,
    new_opportunity={"score": 60, "direction": "SHORT"},
    historical_stats={"avg_profit": 0.8, "win_rate": 0.5}
)

# ç»“æœ
{
    "should_switch": True/False,
    "current_expected": 1.1,      # å½“å‰é¢„æœŸæ”¶ç›Š%
    "new_expected": 1.8,          # æ–°æœºä¼šé¢„æœŸæ”¶ç›Š%
    "advantage": 1.64,            # æ–°æœºä¼šä¼˜åŠ¿å€æ•°
    "reason": "æ–°æœºä¼šæ”¶ç›Š(1.8%)æ˜¯å½“å‰(1.1%)çš„1.6å€",
    "confidence": 0.55
}
```

### run_once() é›†æˆ

```python
# åœ¨æœ‰æŒä»“æ—¶ï¼ŒåŒæ—¶æ£€æŸ¥æ–°æœºä¼š
if self.current_position:
    # æ£€æŸ¥åå‘æœºä¼š
    potential_signal = self.should_enter(market_state)
    if potential_signal and potential_signal["direction"] != current_direction:
        new_opportunity = potential_signal
    
    # ä½¿ç”¨å¢å¼ºç‰ˆè¯„ä¼°
    decision = self.exit_manager.evaluate_exit_with_opportunity(
        state=...,
        new_opportunity=new_opportunity,
        historical_stats=...
    )
    
    # å¦‚æœå†³å®šåˆ‡æ¢
    if decision.reason == "OPPORTUNITY_SWITCH":
        self.execute_exit(...)      # å¹³ä»“
        self.execute_entry(...)     # å¼€æ–°ä»“
```

---

## æ—¥å¿—ç¤ºä¾‹

```
   ğŸ” å‘ç°åå‘æœºä¼š: SHORT å¾—åˆ†65
   ğŸ”„ æœºä¼šæˆæœ¬åˆ‡æ¢: å¹³ä»“åç«‹å³å¼€æ–°ä»“ SHORT
   
ã€è¡ŒåŠ¨ã€‘æœºä¼šåˆ‡æ¢: LONGâ†’SHORT
   åŸå› : æ–°æœºä¼šæ”¶ç›Š(1.8%)æ˜¯å½“å‰(1.1%)çš„1.6å€
   å½“å‰é¢„æœŸ:1.1% â†’ æ–°æœºä¼š:1.8%
```

---

## é£é™©æç¤º

1. **è¿‡åº¦äº¤æ˜“é£é™©**ï¼šé¢‘ç¹åˆ‡æ¢ä¼šç´¯ç§¯æ‰‹ç»­è´¹
   - è§£å†³ï¼š`opportunity_threshold = 1.5` ç¡®ä¿ä¼˜åŠ¿è¶³å¤Ÿå¤§

2. **é”™å¤±å¤§è¡Œæƒ…é£é™©**ï¼šå¯èƒ½åœ¨å¤§è¶‹åŠ¿ä¸­è¢«åå¼¹ä¿¡å·è¯¯å¯¼
   - è§£å†³ï¼šç»“åˆè¶‹åŠ¿å¼ºåº¦åˆ¤æ–­ï¼Œå¼ºè¶‹åŠ¿æ—¶ä¸è½»æ˜“åˆ‡æ¢

3. **æ•°æ®ä¸è¶³é£é™©**ï¼šå†å²ç»Ÿè®¡æ•°æ®å°‘æ—¶é¢„æœŸè®¡ç®—ä¸å‡†
   - è§£å†³ï¼šäº¤æ˜“æ¬¡æ•°<50æ—¶ä½¿ç”¨ä¿å®ˆé»˜è®¤å€¼

---

## è°ƒä¼˜å»ºè®®

| åœºæ™¯ | è°ƒæ•´æ–¹å‘ |
|------|---------|
| åˆ‡æ¢å¤ªé¢‘ç¹ | æé«˜ `opportunity_threshold` åˆ° 2.0 |
| åˆ‡æ¢å¤ªä¿å®ˆ | é™ä½ `opportunity_threshold` åˆ° 1.2 |
| å°ç›ˆåˆ©å°±åˆ‡æ¢ | æé«˜ `min_profit_to_switch` åˆ° 0.5% |
| æ‰‹ç»­è´¹å¤ªé«˜ | æé«˜ `trading_cost` åˆ°å®é™…å€¼ |

























