# 最佳支撑阻力位发现系统 v3

## 核心思想

**训练时间越久 → 特征验证越充分 → 权重越准确 → 找到的最佳价位越有效 → 胜率越高**

## 系统流程

```
┌─────────────────────────────────────────────────────────────┐
│  1. 发现候选价位                                             │
│     - Pivot高低点                                           │
│     - 成交量密集区                                           │
│     - 近期摆动高低点                                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  2. 计算每个价位的6个特征值                                   │
│     - 成交量密集度 (volume_density)                          │
│     - 触及反弹次数 (touch_bounce_count)                      │
│     - 反弹幅度 (bounce_magnitude)                            │
│     - 假突破次数 (failed_breakout_count)                     │
│     - 有效持续天数 (duration_days)                           │
│     - 多周期确认 (multi_tf_confirm)                          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  3. 用当前权重计算得分，选出最佳                              │
│     得分 = Σ(特征值 × 权重) × 100                            │
│     🟢 最佳支撑 = 支撑中得分最高的1个                         │
│     🔴 最佳阻力 = 阻力中得分最高的1个                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  4. 交易执行                                                 │
│     - 结合趋势、RSI、MACD、布林带等确认                       │
│     - 在最佳支撑附近做多 / 在最佳阻力附近做空                  │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  5. 记录交易结果                                             │
│     - 价位是否有效（止损没被触发 = 有效）                     │
│     - 盈亏百分比                                             │
│     - 使用的价位特征值                                       │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  6. 统计分析（需要至少30笔交易）                              │
│     - 计算每个特征在"有效交易"和"无效交易"中的平均值          │
│     - 差值大 = 特征有用 → 增加权重                           │
│     - 差值小 = 特征无效 → 降低权重                           │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  7. 权重微调                                                 │
│     - 平滑更新（学习率0.3）                                  │
│     - 记录调整历史                                           │
│     - 循环回到步骤3                                          │
└─────────────────────────────────────────────────────────────┘
```

## 初始权重

| 特征 | 初始权重 | 说明 |
|------|----------|------|
| volume_density | 20% | 成交量密集度 |
| touch_bounce_count | 20% | 触及反弹次数 |
| failed_breakout_count | 20% | 假突破次数 |
| bounce_magnitude | 15% | 反弹幅度 |
| multi_tf_confirm | 15% | 多周期确认 |
| duration_days | 10% | 有效持续天数 |

## 权重调整逻辑

```python
# 计算特征有效性
for feature in features:
    有效交易平均值 = mean(有效交易的该特征值)
    无效交易平均值 = mean(无效交易的该特征值)
    差值 = 有效交易平均值 - 无效交易平均值
    
    # 差值越大，特征越有用
    有效性 = max(0.05, 0.5 + 差值 * 2)

# 归一化
总有效性 = sum(所有特征有效性)
新权重 = 有效性 / 总有效性

# 平滑更新
最终权重 = 旧权重 * 0.7 + 新权重 * 0.3
```

## 学习进度

- **0-29笔交易**：使用初始权重，积累数据
- **30+笔交易**：开始基于统计调整权重
- **100+笔交易**：权重趋于稳定，准确率提升

## 文件结构

```
binance-futures-trading/rl/
├── level_finder.py      # 最佳价位发现器
│   ├── LevelFeatureCalculator  # 特征计算
│   └── BestLevelFinder         # 发现+评分+学习
├── agent.py             # 交易Agent
└── rl_data/
    └── level_stats.json # 统计数据和权重
```

## 统计数据格式

```json
{
    "total_trades": 50,
    "effective_trades": 35,
    "weights": {
        "volume_density": 0.22,
        "touch_bounce_count": 0.18,
        ...
    },
    "weight_history": [
        {"timestamp": "...", "weights": {...}, "effectiveness_rate": 0.7}
    ],
    "trade_history": [
        {"price": 95000, "score": 72, "features": {...}, "was_effective": true, "pnl_percent": 1.5}
    ]
}
```

## 思维链展示

每笔交易的思维链包含：

1. **感知**：当前价格、趋势、最佳支撑/阻力、特征值
2. **行动**：入场方向、价格、止损止盈、确认因素
3. **奖励**：盈亏、价位有效性、学习进度

## 关键指标

- **有效率**：价位没被突破的比例（目标>70%）
- **学习进度**：当前交易数/30
- **权重调整次数**：系统优化了多少次
