# 交易系统全局架构 🏗️

## 系统总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           短线量化交易系统 v3.0                               │
│                                                                             │
│  核心理念: 支撑阻力位 + 趋势共振 + 机会成本优化 + 强化学习                      │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │   市场数据    │
                              │ 1m/15m/8h/1w │
                              └──────┬───────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
            │  技术指标计算  │ │ 支撑阻力发现  │ │  趋势分析    │
            │ indicators.py │ │level_finder  │ │  agent.py   │
            └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
                   │                │                │
                   └────────────────┼────────────────┘
                                    ▼
                           ┌──────────────────┐
                           │    感知层        │
                           │  (Perception)   │
                           │                 │
                           │ • ADX趋势强度   │
                           │ • 价格结构分析   │
                           │ • 单边行情检测   │
                           │ • 最佳支撑阻力   │
                           └────────┬────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │  入场决策    │ │  持仓管理    │ │  出场决策    │
            │should_enter │ │PositionState│ │evaluate_exit│
            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
                   │               │               │
                   └───────────────┼───────────────┘
                                   ▼
                          ┌───────────────┐
                          │   行动层      │
                          │  (Action)     │
                          │               │
                          │ • 开仓/平仓   │
                          │ • 机会成本切换 │
                          │ • 动态止损    │
                          └───────┬───────┘
                                  │
                                  ▼
                          ┌───────────────┐
                          │   奖励层      │
                          │  (Reward)     │
                          │               │
                          │ • 盈亏统计    │
                          │ • 价位有效性  │
                          │ • 分离归因    │
                          └───────┬───────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │ 价位权重学习 │ │ 止盈止损学习 │ │  入场学习   │
            │ WeightOptim │ │ SLTPLearner │ │EntryLearner│
            └─────────────┘ └─────────────┘ └─────────────┘
```

---

## 模块职责一览

### 1️⃣ 数据层

| 模块 | 文件 | 职责 |
|------|------|------|
| 技术指标 | `indicators.py` | RSI、MACD、布林带、ADX、EMA等 |
| K线数据 | Binance API | 多周期K线获取 |

### 2️⃣ 感知层（核心改进区）

| 模块 | 文件 | 职责 | 状态 |
|------|------|------|------|
| 趋势分析 | `agent.py` | 大小趋势判断、ADX、价格结构 | ✅ 已升级 |
| 支撑阻力 | `level_finder.py` | 发现和评分关键价位 | ✅ 已优化 |
| 单边检测 | `indicators.py` | 检测单边行情 | ✅ 新增 |

### 3️⃣ 决策层

| 模块 | 文件 | 职责 | 状态 |
|------|------|------|------|
| 入场决策 | `agent.py:should_enter` | 多重确认入场 | ✅ 短线优化 |
| 入场学习 | `entry_learner_v2.py` | 神经网络评估入场质量 | ✅ |
| 出场决策 | `exit_manager.py` | 智能平仓、分批减仓 | ✅ 机会成本 |
| 止盈止损 | `sl_tp.py` + `sl_tp_learner.py` | 计算和学习最优SL/TP | ✅ |

### 4️⃣ 学习层

| 模块 | 文件 | 学习内容 | 预期收益 |
|------|------|---------|---------|
| 价位权重 | `level_weight_learner.py` | 哪些特征决定价位有效性 | 3-5% |
| 止盈止损 | `sl_tp_learner.py` | 最优止损/止盈距离 | 5-15% |
| 入场时机 | `entry_learner_v2.py` | 何时入场胜率最高 | 5-10% |
| 出场策略 | `exit_manager.py` | 分批减仓参数 | 3-8% |

---

## 决策流程图

```
                          开始
                            │
                            ▼
                    ┌───────────────┐
                    │  获取K线数据   │
                    │ 1m/15m/8h/1w  │
                    └───────┬───────┘
                            │
                            ▼
                    ┌───────────────┐
                    │  分析市场状态  │
                    │ analyze_market│
                    └───────┬───────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ 计算技术指标   │   │ 发现支撑阻力   │   │ 判断大小趋势   │
│ RSI/MACD/BB  │   │ level_finder  │   │ ADX/结构/EMA │
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │   有持仓吗？   │
                    └───────┬───────┘
                            │
            ┌───────────────┴───────────────┐
            │ 有                            │ 无
            ▼                               ▼
    ┌───────────────┐               ┌───────────────┐
    │ 更新价格极值   │               │ 检查入场条件   │
    │update_extremes│               │ should_enter  │
    └───────┬───────┘               └───────┬───────┘
            │                               │
            ▼                               │
    ┌───────────────┐                       │
    │ 检查反向机会   │                       │
    │ (机会成本)    │                       │
    └───────┬───────┘                       │
            │                               │
            ▼                               │
    ┌───────────────────────┐               │
    │ evaluate_exit_with_   │               │
    │ opportunity           │               │
    └───────┬───────────────┘               │
            │                               │
    ┌───────┴───────┐                       │
    │               │                       │
    ▼               ▼                       ▼
┌────────┐    ┌────────┐              ┌────────┐
│止损/止盈│    │机会切换│              │  入场  │
│ 平仓   │    │平仓+开仓│              │execute│
└────────┘    └────────┘              └────────┘
    │               │                       │
    └───────────────┼───────────────────────┘
                    │
                    ▼
            ┌───────────────┐
            │  记录奖励     │
            │ 更新学习器    │
            └───────────────┘
```

---

## 数据流转

```
K线数据 ─────────────────────────────────────────────────────────────┐
    │                                                                │
    ▼                                                                │
┌─────────────┐                                                      │
│ indicators  │ → RSI, MACD, BB, ADX, 价格结构, 单边检测              │
└─────────────┘                                                      │
    │                                                                │
    ▼                                                                │
┌─────────────┐                                                      │
│level_finder │ → 支撑位[], 阻力位[], 评分                           │
└─────────────┘                                                      │
    │                                                                │
    └──────────────────────┬─────────────────────────────────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ market_state│
                    │ {           │
                    │   current_price,     │
                    │   macro_trend,       │ ← 大趋势(方向+强度+类型)
                    │   micro_trend,       │ ← 小趋势(方向+强度+类型)
                    │   best_support,      │ ← 最佳支撑位
                    │   best_resistance,   │ ← 最佳阻力位
                    │   analysis_1m,       │ ← 1分钟指标
                    │   analysis_15m,      │ ← 15分钟指标
                    │   ...               │
                    │ }                   │
                    └─────────────┘
                           │
                           ▼
            ┌──────────────┴──────────────┐
            │                             │
            ▼                             ▼
    ┌─────────────┐               ┌─────────────┐
    │should_enter │               │evaluate_exit│
    │             │               │             │
    │ 输出:       │               │ 输出:       │
    │ {direction, │               │ {action,    │
    │  score,     │               │  reason,    │
    │  reason,    │               │  quantity}  │
    │  key_level} │               └─────────────┘
    └─────────────┘
            │
            ▼
    ┌─────────────┐
    │execute_entry│
    │             │
    │ 输出:       │
    │ {trade_id,  │
    │  entry_price│
    │  stop_loss, │
    │  take_profit│
    │  ...}       │
    └─────────────┘
            │
            ▼
    ┌─────────────────┐
    │ 交易结果反馈     │
    │ {pnl, pnl_%,    │
    │  exit_reason,   │
    │  lowest_price,  │ ← 用于分离归因
    │  highest_price} │
    └─────────────────┘
            │
            ▼
    ┌─────────────────┐
    │ 更新所有学习器   │
    │ • WeightOptimizer    ← 价位权重
    │ • SLTPLearner        ← 止盈止损
    │ • EntryLearner       ← 入场时机
    │ • ExitManager        ← 出场策略
    └─────────────────┘
```

---

## 关键配置参数

### 入场相关

| 参数 | 位置 | 默认值 | 含义 |
|------|------|--------|------|
| `distance_threshold` | agent.py | 2-5% | 距离支撑阻力的阈值 |
| `min_score` | agent.py | 5-40 | 最低入场分数 |
| `training_mode` | agent.py | True | 训练模式(放宽条件) |

### 出场相关

| 参数 | 位置 | 默认值 | 含义 |
|------|------|--------|------|
| `opportunity_threshold` | exit_manager.py | 1.5 | 机会成本切换阈值 |
| `trailing_trigger` | exit_manager.py | 0.8% | 移动止损触发 |
| `max_hold_time` | exit_manager.py | 60分钟 | 最大持仓时间 |

### 学习相关

| 参数 | 位置 | 默认值 | 含义 |
|------|------|--------|------|
| `epsilon` | sl_tp_learner.py | 0.15 | 探索率 |
| `learning_rate` | level_weight_learner.py | 0.001 | 权重学习率 |
| `min_trades` | 各学习器 | 20-50 | 开始学习所需最小交易数 |

---

## 思维链记录格式

```
【感知】大势:📈上涨(强势) 小势:↗️偏涨(中等) | 结构:HH+HL↑ | ✅共振
   关键位: 支撑90575(距0.1%) 阻力90597(距0.0%)

【行动】做多@90672 🎲探索
   止损:89760 | 止盈:93730 | 风险比:3.86 | 杠杆:10x

【奖励】✅ 止盈 +12.50U (+1.38%)
   出场: 达到止盈 | 价位✓
```

---

## 已实现的核心功能 ✅

| 功能 | 状态 | 描述 |
|------|------|------|
| 多周期趋势分析 | ✅ | 1m/15m/8h/1w 四周期 |
| ADX趋势强度 | ✅ | 量化趋势强度0-100 |
| 价格结构分析 | ✅ | 道氏理论HH/HL/LH/LL |
| 单边行情检测 | ✅ | 避免逆势交易 |
| 趋势共振加分 | ✅ | 大小趋势一致时加分 |
| 支撑阻力发现 | ✅ | 多维特征评分 |
| 分离归因奖励 | ✅ | 精确学习信号 |
| 机会成本优化 | ✅ | 动态切换仓位 |
| 止盈止损学习 | ✅ | 神经网络优化 |
| 入场时机学习 | ✅ | 探索-利用平衡 |
| 训练模式开关 | ✅ | Web界面控制 |
| 思维链记录 | ✅ | 决策透明化 |

---

## 待优化/观察项 🔍

| 项目 | 优先级 | 说明 |
|------|--------|------|
| 学习曲线监控 | 高 | 需要观察100+笔交易后的效果 |
| 参数自适应 | 中 | 根据市场波动率调整参数 |
| 多币种扩展 | 低 | 目前只支持BTCUSDT |
| 回测验证 | 高 | 用历史数据验证改进效果 |

---

## 系统健康检查清单

```bash
□ rl_data/ 目录存在且有写入权限
□ sl_tp_model.json 模型文件存在
□ entry_model.json 模型文件存在  
□ level_weights.json 权重文件存在
□ trades.json 交易记录正常
□ Web界面可访问
□ Binance API连接正常
□ 训练模式状态正确
```

























