# 🎰 智能杠杆系统使用说明

**实现时间**: 2026-01-14  
**版本**: v1.0  
**状态**: ✅ 已实现并可用

---

## 📋 功能概述

智能杠杆系统会根据以下因素**动态调整每笔交易的杠杆倍数**：

### 调整因素

1. **信号强度** (权重35%)
   - 评分越高，杠杆越大
   - 80+分 → 1.5倍乘数
   - 60-80分 → 1.3倍乘数  
   - 45-60分 → 1.1倍乘数
   - 30-45分 → 1.0倍乘数
   - <30分 → 0.8倍乘数

2. **历史胜率** (权重35%)
   - 胜率越高，杠杆越大
   - >65% → 1.4倍乘数
   - 55-65% → 1.2倍乘数
   - 45-55% → 1.0倍乘数  
   - 35-45% → 0.8倍乘数
   - <35% → 0.6倍乘数（强制降低）

3. **账户回撤** (权重25%)
   - 回撤越大，杠杆越小
   - <3% → 1.2倍乘数
   - 3-5% → 1.0倍乘数
   - 5-8% → 0.8倍乘数
   - 8-12% → 0.6倍乘数
   - >12% → 0.5倍乘数（强制大幅降低）

4. **连续盈亏** (权重5%)
   - 连续5次盈利 → +10%杠杆
   - 连续3次亏损 → -15%杠杆
   - 连续5次亏损 → -30%杠杆（保护资金）

5. **Kelly公式优化** (可选，权重30%)
   - 基于历史盈亏比计算最优仓位
   - 使用Half-Kelly更保守
   - 需要至少20笔交易数据

---

## ⚙️ 系统参数

### 杠杆范围
- **最小杠杆**: 5倍（保守下限）
- **基准杠杆**: 10倍（中等信号）
- **最大杠杆**: 50倍（强信号+高胜率，高风险！）

### 计算示例

**场景1: 强信号+高胜率+低回撤**
```
基础: 10倍
信号80分: ×1.5
胜率60%: ×1.2
回撤2%: ×1.2
连续3次盈利: ×1.05

最终: 10 × 1.5 × 1.2 × 1.2 × 1.05 = 22.68 → 限制为20倍
```

**场景2: 中等信号+普通胜率**
```
基础: 10倍
信号50分: ×1.1
胜率50%: ×1.0
回撤4%: ×1.0

最终: 10 × 1.1 × 1.0 × 1.0 = 11倍
```

**场景3: 弱信号+连续亏损+高回撤**
```
基础: 10倍
信号35分: ×0.8
胜率40%: ×0.8
回撤10%: ×0.6
连续3次亏损: ×0.85

最终: 10 × 0.8 × 0.8 × 0.6 × 0.85 = 3.26 → 限制为5倍（最小）
```

---

## 📊 监控和统计

### 日志显示

开仓时会显示：
```
🎰 智能杠杆: 15x (基于信号75分, 胜率58.5%, 回撤3.2% → 建议15x杠杆)
🚀 开仓1/3 LONG @ 95400.00
   杠杆: 15x | 止损: 94850.00, 止盈: 97200.00
```

平仓时会记录：
```
🎰 杠杆15x表现已记录: 盈利 2.35%
```

### API端点

可以通过 API 查看杠杆统计：
```
GET /api/agent/leverage_stats
```

返回：
```json
{
  "total_trades": 150,
  "avg_leverage": 12.5,
  "leverage_distribution": {
    "5": 10,   // 5倍杠杆用了10次
    "10": 50,  // 10倍杠杆用了50次
    "15": 60,  // 15倍杠杆用了60次
    "20": 30   // 20倍杠杆用了30次
  },
  "leverage_performance": {
    "5": {
      "trades": 10,
      "wins": 6,
      "win_rate": 0.6,
      "avg_pnl": 1.2
    },
    "10": {
      "trades": 50,
      "wins": 28,
      "win_rate": 0.56,
      "avg_pnl": 1.8
    },
    ...
  }
}
```

---

## 🔧 配置和调整

### 修改参数

如果需要调整杠杆范围，编辑 `rl/leverage_optimizer.py`:

```python
# 基础参数
self.base_leverage = 10      # 基准杠杆
self.min_leverage = 5        # 最小杠杆
self.max_leverage = 20       # 最大杠杆（建议不超过20）
```

### 调整权重

修改各因素的乘数：

```python
def _calculate_signal_multiplier(self, score: float) -> float:
    if score >= 80:
        return 1.5  # 可以调整为1.4或1.6
    ...
```

---

## ⚠️ 风险提示

### 高杠杆风险

- **20倍杠杆**: 价格波动5%可能导致爆仓
- **建议**: 只在非常强的信号下使用高杠杆
- **保护**: 系统会在回撤大时自动降低杠杆

### 连续亏损保护

当检测到连续亏损时：
- 3次亏损 → 降低15%杠杆
- 5次亏损 → 降低30%杠杆
- 防止追涨杀跌放大亏损

### 回撤保护

当账户回撤超过阈值时：
- 8-12%回撤 → 降至6倍以下
- >12%回撤 → 强制降至5倍
- 保护本金，避免深度亏损

---

## 📈 学习和优化

### 自动学习

系统会自动记录：
- 每个杠杆倍数的胜率
- 每个杠杆倍数的平均盈亏
- 不同市场状态下的最优杠杆

### 持续优化

随着交易数据增加：
- Kelly公式会更准确
- 杠杆选择会更智能
- 风险收益比会提升

---

## 🚀 使用方法

### 1. 启动Agent

智能杠杆会自动启用，无需额外配置。

### 2. 观察日志

注意查看：
- 开仓时的杠杆倍数
- 杠杆决策理由
- 每笔交易的杠杆表现

### 3. 查看统计

定期检查 `/api/agent/leverage_stats` 了解：
- 平均杠杆使用情况
- 不同杠杆的表现
- 是否需要调整参数

---

## ❓ 常见问题

### Q: 杠杆会不会太高导致爆仓？

A: 不会。系统有多重保护：
- 最大杠杆限制20倍
- 回撤自动降杠杆
- 连续亏损强制降低
- 止损保护

### Q: 为什么有时杠杆很低（5倍）？

A: 可能是：
- 信号较弱（<30分）
- 最近胜率低（<40%）
- 账户回撤大（>10%）
- 连续亏损（>3次）

这是**保护机制**，防止在不利条件下放大亏损。

### Q: 如何提高平均杠杆？

A: 需要提升交易质量：
- 提高信号质量（优化入场条件）
- 提升胜率（优化止盈止损）
- 控制回撤（严格风险管理）
- 避免连续亏损（遵守纪律）

### Q: 能否固定使用某个杠杆？

A: 可以，但不推荐。如果必须：
1. 修改 `leverage_optimizer.py`
2. 让 `calculate_dynamic_leverage()` 返回固定值
3. 或者注释掉动态杠杆，恢复使用 `self.leverage`

---

## 📊 性能预期

### 理想情况

- **胜率55%+**: 平均杠杆12-15倍
- **胜率60%+**: 平均杠杆15-18倍
- **风险控制**: 最大回撤<10%

### 实际表现

根据历史数据（需要至少50笔交易）：
- 智能杠杆可提升**收益15-25%**
- 同时**控制风险不增加**
- 在强信号时最大化收益
- 在弱信号时保护资金

---

## 📝 更新日志

**v1.0** (2026-01-14)
- ✅ 实现动态杠杆计算
- ✅ 集成信号强度、胜率、回撤因素
- ✅ 添加Kelly公式优化
- ✅ 实现杠杆表现统计
- ✅ 添加API接口
- ✅ 集成到Agent系统

---

**祝您交易顺利！** 🎉

如有任何问题或建议，请随时反馈。

